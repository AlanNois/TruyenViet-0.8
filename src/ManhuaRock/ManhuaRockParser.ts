import {
    Chapter,
    SourceManga,
    Tag,
    TagSection,
    PartialSourceManga
} from '@paperback/types'
const entities = require("entities"); //Import package for decoding HTML entities


export class Parser {

    /* The above code is defining a private method called `decodeHTMLEntity` in a TypeScript class.
    This method takes a string as input and returns a decoded version of the string where HTML
    entities have been replaced with their corresponding characters. The decoding is done using the
    `entities.decodeHTML` function. */
    private decodeHTMLEntity = (str: string): string => {
        return entities.decodeHTML(str);
    }

    /**
     * The function `parseMangaDetails` takes in a CheerioStatic object and a mangaId string, and
     * parses the manga details from the object to create and return a SourceManga object.
     * @param {CheerioStatic} $ - The CheerioStatic parameter is a reference to the Cheerio library,
     * which is used for parsing HTML.
     * @param {string} mangaId - The mangaId parameter is a string that represents the unique
     * identifier of a manga. It is used to fetch the details of a specific manga from a source.
     * @returns a SourceManga object.
     */
    parseMangaDetails($: CheerioStatic, mangaId: string): SourceManga {
        const tags: Tag[] = [];

        let author = '';
        let artist = '';

        $('.post-content > .post-content_item').each((_: any, obj: any) => {
            switch ($('.summary-heading', obj).text().trim()) {
                case "T√°c gi·∫£":
                    author = $('.summary-content', obj).text().trim();
                    break;
                case "Ho·∫° s·ªπ":
                    artist = $('.summary-content', obj).text().trim();
                    break;
                case "Th·ªÉ lo·∫°i":
                    $('.summary-content > .genres-content > a').each((_: any, tag: any) => {
                        const label = $(tag).text().trim();
                        const id = $(obj).attr('href')?.split('/').pop() ?? label
                        tags.push(App.createTag({ label, id }))
                    });
                    break;
            }
        })

        const titles = $('.post-title > h1').text().trim();
        const image = String($('.summary_image > a > img').attr('src'));
        const desc = this.decodeHTMLEntity($('.dsct > p').text());
        const status = $('.post-status > div:nth-child(2) > div.summary-content').text().trim();
        const rating = parseFloat($('span[property="ratingValue"]').text().trim())

        return App.createSourceManga({
            id: mangaId,
            mangaInfo: App.createMangaInfo({
                titles: [titles],
                author,
                artist,
                image,
                desc,
                status,
                tags: [App.createTagSection({ id: '0', label: 'genres', tags })],
                rating: Number.isNaN(rating) ? 0 : rating
            }),
        })
    }

    /**
     * The function `parseChapterList` takes a CheerioStatic object and returns an array of Chapter
     * objects by extracting data from the HTML structure.
     * @param {CheerioStatic} $ - The parameter `$` is a reference to the CheerioStatic object, which
     * is a jQuery-like library for parsing HTML. It is used to select and manipulate elements in the
     * HTML document.
     * @returns an array of Chapter objects.
     */
    parseChapterList($: CheerioStatic): Chapter[] {
        const chapters: Chapter[] = [];

        $('.row-content-chapter > li').each((_: any, obj: any) => {
            const id = String($('a', obj).attr('href')?.split('/').slice(4).join('/'));
            const view_n_time = $('span', obj).text().trim().split('-');
            const time = new Date(String(view_n_time[1]));
            const group = view_n_time[0];
            const name = $('a', obj).text();
            const chapNum = $('a', obj).text().split(' ')[1];

            /* The code `chapters.push(App.createChapter({ id, chapNum: parseFloat(String(chapNum)),
            name, langCode: 'üáªüá≥', time, group }))` is creating a new Chapter object and pushing it
            into the `chapters` array. */
            chapters.push(App.createChapter({
                id,
                chapNum: parseFloat(String(chapNum)),
                name,
                langCode: 'üáªüá≥',
                time,
                group
            }))
        })

        if (chapters.length == 0) {
            throw new Error('No chapter found')
        }

        return chapters
    }

    /**
     * The function "parseChapterDetails" takes a CheerioStatic object as input, iterates over a
     * collection of image elements, extracts the "data-src" attribute value from each element, and
     * returns an array of these values.
     * @param {CheerioStatic} $ - CheerioStatic - This is a reference to the Cheerio library, which is
     * used for parsing and manipulating HTML.
     * @returns The function `parseChapterDetails` returns an array of strings, which represents the
     * links to the pages of a chapter.
     */
    parseChapterDetails($: CheerioStatic): string[] {
        const pages: string[] = [];

        $('.image-placeholder > img').each((_: any, obj: any) => {
            if (!obj.attribs['data-src']) return;
            const link = obj.attribs['data-src'];
            pages.push(link);
        });

        return pages
    }

    /**
     * The function parses search results from a website and returns an array of partial manga objects.
     * @param {CheerioStatic} $ - CheerioStatic - A reference to the Cheerio library, which is used for
     * parsing HTML.
     * @returns an array of objects of type PartialSourceManga.
     */
    parseSearchResults($: CheerioStatic): PartialSourceManga[] {
        const tiles: PartialSourceManga[] = [];

        $('.page-item', '.listupd').each((_: any, manga: any) => {
            const title = $('div > div > h3', manga).text().trim();
            const id = $('div > div > h3 > a', manga).attr('href')?.split('/').slice(4).join('/');
            let image = $('div > div > a > img', manga).first().attr('data-src');
            image = !image ? "https://i.imgur.com/GYUxEX8.png" : image
            const subtitle = $("div > div > .list-chapter > div:nth-of-type(1) > span", manga).text().trim();
            if (!id || !title) return;

            tiles.push(App.createPartialSourceManga({
                mangaId: String(id),
                image: String(image),
                title: title,
                subtitle: subtitle,
            }));
        });

        return tiles
    }

    parseFeaturedSection($: CheerioStatic): PartialSourceManga[] {
        const featuredItems: PartialSourceManga[] = [];

        $('.p-item', '.sidebar > div:nth-child(5) > div.sidebar-pp').each((_: any, manga: any) => {
            const title = $('.p-left > h4', manga).text().trim();
            const id = $('.p-left > h4 > a', manga).attr('href')?.split('/').slice(4).join('/');
            let image = $('.pthumb > img', manga).first().attr('data-src');
            image = !image ? "https://i.imgur.com/GYUxEX8.png" : image
            const subtitle = $(".p-left > .list-chapter > div:nth-of-type(1) > span", manga).first().text().trim();
            if (!id || !title) return;

            featuredItems.push(App.createPartialSourceManga({
                mangaId: String(id),
                image: String(image),
                title: title,
                subtitle: subtitle,
            }));
        });

        return featuredItems
    }

    parseTags(): TagSection[] {
        const arrayTags: Tag[] = [
            { id: "yuri", label: "Yuri" },
            { id: "yaoi", label: "Yaoi" },
            { id: "xuyen-sach", label: "Xuy√™n S√°ch" },
            { id: "xuyen-nhanh", label: "Xuy√™n Nhanh" },
            { id: "xuyen-khong", label: "Xuy√™n Kh√¥ng" },
            { id: "webtoons", label: "Webtoons" },
            { id: "webtoon", label: "Webtoon" },
            { id: "vuong-gia", label: "V∆∞∆°ng Gia" },
            { id: "vuon-truong", label: "V∆∞·ªùn Tr∆∞·ªùng" },
            { id: "vo-thuat", label: "V√µ Thu·∫≠t" },
            { id: "vo-hiep", label: "V√µ Hi·ªáp" },
            { id: "vien-tuong", label: "Vi·ªÖn T∆∞·ªüng" },
            { id: "tu-tien", label: "Tu Ti√™n" },
            { id: "tu-luyen", label: "Tu Luy·ªán" },
            { id: "truyen-tranh", label: "Truy·ªán Tranh" },
            { id: "truyen-nhat-manga", label: "Truy·ªán Nh·∫≠t (Manga)" },
            { id: "truyen-nam", label: "Truy·ªán Nam" },
            { id: "truyen-mau", label: "Truy·ªán M√†u" },
            { id: "truyen-ma", label: "Truy·ªán Ma" },
            { id: "trung-sinh", label: "Tr√πng Sinh" },
            { id: "trong-sinh", label: "Tr·ªçng Sinh" },
            { id: "trinh-tham", label: "Trinh Th√°m" },
            { id: "tragedy", label: "Tragedy" },
            { id: "tra-thu", label: "Tr·∫£ Th√π" },
            { id: "tong-tai", label: "T·ªïng T√†i" },
            { id: "tinh-yeu", label: "T√¨nh Y√™u" },
            { id: "tinh-cam", label: "TiÃÄnh CaÃâm" },
            { id: "thuan-phuc-thu", label: "Thu·∫ßn Ph·ª•c Th√∫" },
            { id: "thieu-nhi", label: "Thi·∫øu Nhi" },
            { id: "thien-tai", label: "Thi√™n T√†i" },
            { id: "the-thao", label: "Th·ªÉ Thao" },
            { id: "thanh-xuan-vuon-truong", label: "Thanh Xu√¢n V∆∞·ªùn Tr∆∞·ªùng" },
            { id: "thanh-xuan", label: "Thanh Xu√¢n" },
            { id: "thai-giam", label: "Th√°i Gi√°m" },
            { id: "tap-chi-truyen-t", label: "T·∫°p Ch√≠ Truy·ªán T" },
            { id: "supernatural", label: "Supernatural" },
            { id: "sung-vat", label: "S·ªßng V·∫≠t" },
            { id: "sung", label: "S·ªßng" },
            { id: "sports", label: "Sports" },
            { id: "soft-yuri", label: "Soft Yuri" },
            { id: "smut", label: "Smut" },
            { id: "slice-of-life", label: "Slice of life" },
            { id: "sieu-nhien", label: "Si√™u Nhi√™n" },
            { id: "showbiz", label: "Showbiz" },
            { id: "shounen-ai", label: "Shounen Ai" },
            { id: "shounen", label: "Shounen" },
            { id: "shoujo-ai", label: "Shoujo Ai" },
            { id: "shoujo", label: "Shoujo" },
            { id: "series", label: "Series" },
            { id: "seinen", label: "Seinen" },
            { id: "sci-fi", label: "Sci-Fi" },
            { id: "school-life", label: "School Life" },
            { id: "sang-van", label: "S·∫£ng VƒÉn" },
            { id: "san-ban", label: "SƒÉn B·∫Øn" },
            { id: "romance", label: "Romance" },
            { id: "quai-vat", label: "Qu√°i V·∫≠t" },
            { id: "psychological", label: "Psychological" },
            { id: "phieu-luu", label: "Phi√™u L∆∞u" },
            { id: "phep-thuat", label: "Ph√©p Thu·∫≠t" },
            { id: "phap-y", label: "Ph√°p Y" },
            { id: "phan-dien", label: "Ph·∫£n Di·ªán" },
            { id: "one-shot", label: "One Shot" },
            { id: "nu-phu", label: "N·ªØ Ph·ª•" },
            { id: "nu-gia-nam", label: "N·ªØ Gi·∫£ Nam" },
            { id: "nu-cuong", label: "N·ªØ C∆∞·ªùng" },
            { id: "nhiet-huyet", label: "Nhi·ªát Huy·∫øt" },
            { id: "nguoi-lon", label: "Ng∆∞·ªùi L·ªõn" },
            { id: "nguoc", label: "Ng∆∞·ª£c" },
            { id: "ngu-thu", label: "Ng·ª± Th√∫" },
            { id: "ngot-sung", label: "Ng·ªçt S·ªßng" },
            // { id: "ngon-tu-nhay-cam", label: "Ng√¥n T·ª´ Nh·∫°y C·∫£m" },
            { id: "ngon-tinh", label: "Ng√¥n T√¨nh" },
            // { id: "ngon-t", label: "Ng√¥n T" },
            { id: "net-dep", label: "N√©t ƒê·∫πp" },
            { id: "nau-an", label: "N·∫•u ƒÇn" },
            { id: "mystery", label: "Mystery" },
            { id: "murim", label: "Murim" },
            { id: "mecha", label: "Mecha" },
            { id: "mature", label: "Mature" },
            { id: "mat-the", label: "M·∫°t Th·∫ø" },
            { id: "martial-arts", label: "Martial Arts" },
            { id: "mao-hiem", label: "M·∫°o Hi·ªÉm" },
            { id: "manhwa", label: "Manhwa" },
            // {
            //     id: "manhua-ngon-tinh-thanh-xuan-vuon-truong",
            //     label: "Manhua; Ng√¥n T√¨nh; Thanh Xu√¢n V∆∞·ªùn Tr∆∞·ªùng"
            // },
            { id: "manhua", label: "Manhua" },
            { id: "manga", label: "Manga" },
            { id: "magic", label: "Magic" },
            // { id: "magi", label: "Magi" },
            { id: "luan-hoi", label: "Lu√¢n H·ªìi" },
            { id: "live-action", label: "Live Action" },
            { id: "linh-di", label: "Linh D·ªã" },
            { id: "lich-su", label: "L·ªãch S·ª≠" },
            { id: "lgbt", label: "Lgbt+" },
            { id: "leo-thap", label: "Leo Th√°p" },
            { id: "lang-man", label: "L√£ng M·∫°n" },
            { id: "ky-ao", label: "K·ª≥ ·∫¢o" },
            { id: "kinh-di", label: "Kinh D·ªã" },
            { id: "kiem-hiep", label: "Ki·∫øm Hi·ªáp" },
            { id: "kich-tinh", label: "K·ªãch T√≠nh." },
            { id: "khong-gian", label: "Kh√¥ng Gian" },
            { id: "khong-che", label: "Kh√¥ng Che" },
            { id: "khoa-hoc", label: "Khoa H·ªçc" },
            { id: "josei", label: "Josei" },
            { id: "isekai", label: "Isekai" },
            { id: "huyen-huyen", label: "Huy·ªÅn Huy·ªÖn" },
            { id: "huyen-bi", label: "Huy·ªÅn B√≠" },
            { id: "horror", label: "Horror" },
            { id: "hoc-duong", label: "H·ªçc ƒê∆∞·ªùng" },
            { id: "hoang-cung", label: "Ho√†ng Cung" },
            { id: "historical", label: "Historical" },
            { id: "hien-dai", label: "Hi·ªán ƒê·∫°i" },
            { id: "hentaiz", label: "Hentaiz" },
            { id: "hentai", label: "Hentai" },
            { id: "he-thong", label: "H·ªá th·ªëng" },
            { id: "hau-cung", label: "H·∫≠u Cung" },
            { id: "harem", label: "Harem" },
            // { id: "hao-mon-the-gia", label: "H√†o M√¥n Th·∫ø Gia" },
            { id: "hanh-dong", label: "H√†nh ƒê·ªông" },
            { id: "hanh", label: "H√†nh" },
            { id: "ham-nguc", label: "H·∫ßm Ng·ª•c" },
            { id: "hai-huoc", label: "H√†i H∆∞·ªõc." },
            { id: "hai-huoc", label: "H√†i H∆∞·ªõc" },
            { id: "h", label: "H" },
            { id: "gioi-giai-tri", label: "Gi·ªõi Gi·∫£i Tr√≠" },
            { id: "gender-bender", label: "Gender Bender" },
            { id: "game", label: "Game" },
            { id: "full-color", label: "Full Color" },
            { id: "fantasy", label: "Fantasy" },
            { id: "ep-hon", label: "√âp H√¥n" },
            { id: "em-gai-no", label: "Em G√°i N√¥" },
            { id: "ecchi", label: "Ecchi" },
            { id: "do-thi", label: "ƒê√¥ Th·ªã" },
            { id: "dich-nu", label: "ƒê√≠ch N·ªØ" },
            { id: "dao-si", label: "ƒê·∫°o Sƒ©" },
            { id: "dam-my", label: "ƒêam M·ªπ" },
            { id: "dai-nu-chu", label: "ƒê·∫°i N·ªØ Ch·ªß" },
            { id: "dai-lao", label: "ƒê·∫°i L√£o" },
            // { id: "du-hanh-thoi-gian", label: "Du H√†nh Th·ªùi Gian" },
            { id: "drama", label: "Drama" },
            { id: "doujinshi", label: "Doujinshi" },
            { id: "di-toc", label: "D·ªã T·ªôc" },
            { id: "di-nang", label: "D·ªã NƒÉng" },
            { id: "di-gioi", label: "D·ªã Gi·ªõi" },
            { id: "detective", label: "Detective" },
            // { id: "cuoi-truoc-yeu-sau", label: "C∆∞·ªõi Tr∆∞·ªõc Y√™u Sau" },
            { id: "cung-dau", label: "Cung ƒê·∫•u" },
            { id: "cooking", label: "Cooking" },
            { id: "comic", label: "Comic" },
            { id: "comedy", label: "Comedy" },
            { id: "co-trang", label: "C·ªï Trang" },
            { id: "co-dai", label: "C·ªï ƒê·∫°i" },
            { id: "co", label: "C·ªï" },
            { id: "chuyen-sinh", label: "Chuy·ªÉn Sinh" },
            { id: "boylove", label: "BoyLove" },
            { id: "bi-kich", label: "Bi K·ªãch" },
            { id: "benh-kieu", label: "B·ªánh Ki·ªÅu" },
            { id: "beeng-net", label: "Beeng.net" },
            { id: "bathutong", label: "Bathutong" },
            { id: "bao-thu", label: "B√°o Th√π" },
            { id: "bao-luc", label: "B·∫°o L·ª±c" },
            { id: "bach-hop", label: "B√°ch H·ª£p" },
            { id: "ba-dao", label: "B√° ƒê·∫°o" },
            { id: "au-co", label: "√Çu C·ªï" },
            { id: "anime", label: "Anime" },
            { id: "adventure", label: "Adventure" },
            // {
            //     id: "adult-ecchi-fantasy-harem-manhua-truyen-mau-webtoon",
            //     label: "Adult - Ecchi - Fantasy - Harem - Manhua - Truy·ªán M√†u - Webtoon"
            // },
            { id: "adult", label: "Adult" },
            { id: "adaptation", label: "Adaptation" },
            // {
            //     id: "action-manhua-webtoon-truyen-mau-he-thong",
            //     label: "Action   Manhua   Webtoon   Truy·ªán M√†u   H·ªá Th·ªëng"
            // },
            { id: "action", label: "Action" },
            { id: "18", label: "18+" },
            { id: "16", label: "16+" }
        ];
        const arrayTags2: Tag[] = [
            {
                id: 'sort.latest-updated',
                label: 'M·ªõi c·∫≠p nh·∫≠t'
            },
            {
                id: 'sort.score',
                label: 'ƒêi·ªÉm'
            },
            {
                id: 'sort.name-az',
                label: 'T√™n A-Z'
            },
            {
                id: 'sort.release-date',
                label: 'Ng√†y Ph√°t H√†nh'
            },
            {
                id: 'sort.most-viewd',
                label: 'Xem Nhi·ªÅu'
            }
        ];

        // console.log('huh?')

        // $('.sub-menu > ul > li').each((_: any, tag: any) => {
        //     const label = $('a', tag).text().trim();
        //     const id = $('a', tag).attr('href').split('/').pop() ?? label;
        //     if (!id || !label) return;
        //     arrayTags.push({ id: id, label: label });
        // })

        const tagSections: TagSection[] = [
            App.createTagSection({ id: '0', label: 'Th·ªÉ Lo·∫°i (Ch·ªçn 1)', tags: arrayTags.map(x => App.createTag(x)) }),
            App.createTagSection({ id: '1', label: 'S·∫Øp x·∫øp theo (Ch·ªâ ch·ªçn 1)', tags: arrayTags2.map(x => App.createTag(x)) }),
        ];

        return tagSections
    }
}